<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶´‡¶∞‡ßç‡¶Æ ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡¶æ‡¶∞</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-overlay.active { display: flex; }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3; border-top: 5px solid #667eea;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }
        .loading-text { color: white; margin-left: 20px; font-size: 18px; }

        /* App Header */
        .app-header {
            background: white; padding: 20px 30px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }
        .app-header h1 { color: #667eea; font-size: 28px; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }

        /* Buttons */
        .btn {
            padding: 10px 20px; border: none; border-radius: 8px;
            cursor: pointer; font-size: 14px; font-weight: 600;
            transition: all 0.3s; display: inline-flex; align-items: center; gap: 5px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-primary  { background: #667eea; color: white; }
        .btn-success  { background: #48bb78; color: white; }
        .btn-danger   { background: #f56565; color: white; }
        .btn-warning  { background: #ed8936; color: white; }
        .btn-secondary{ background: #718096; color: white; }
        .btn-info     { background: #4299e1; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Card */
        .card {
            background: white; border-radius: 12px; padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
        }

        /* Pages */
        .page { display: none; }
        .page.active { display: block; }

        /* Login Page */
        .login-container { max-width: 400px; margin: 100px auto; }
        .login-card {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: center;
        }
        .login-card h2 { color: #2d3748; margin-bottom: 10px; }
        .login-card p  { color: #718096; margin-bottom: 30px; }

        /* Form Elements */
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; color: #2d3748; font-weight: 600; }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%; padding: 12px; border: 1px solid #cbd5e0;
            border-radius: 6px; font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
        .stat-card .number { font-size: 36px; font-weight: bold; }

        /* Forms List */
        .forms-grid { display: grid; gap: 20px; }
        .form-item {
            background: #f7fafc; border: 2px solid #e2e8f0;
            border-radius: 12px; padding: 20px; transition: all 0.3s;
        }
        .form-item:hover { border-color: #667eea; box-shadow: 0 4px 8px rgba(102,126,234,0.2); }
        .form-item-header h3 { color: #2d3748; margin-bottom: 5px; }
        .form-item-header p  { color: #718096; font-size: 14px; }
        .form-item-meta { color: #718096; font-size: 12px; margin: 10px 0; }
        .form-item-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }

        /* Question Builder */
        .question-item {
            background: #f7fafc; border: 2px solid #e2e8f0;
            border-radius: 12px; padding: 20px; margin-bottom: 20px; transition: all 0.3s;
        }
        .question-item:hover { border-color: #667eea; }
        .question-header { display: flex; gap: 10px; margin-bottom: 15px; }
        .question-header input {
            flex: 1; padding: 10px; border: 1px solid #cbd5e0;
            border-radius: 6px; font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .question-header select {
            width: auto; min-width: 200px; padding: 10px;
            border: 1px solid #cbd5e0; border-radius: 6px; font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .question-image-section {
            background: white; padding: 15px; border-radius: 8px; margin: 15px 0;
        }
        .image-preview-box { margin-top: 10px; }
        .image-preview-box img {
            max-width: 100%; max-height: 300px;
            border-radius: 8px; margin-bottom: 10px;
        }
        .options-list { margin: 15px 0; }
        .option-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .option-row input {
            flex: 1; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .question-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;
        }
        .add-question-btn {
            width: 100%; padding: 15px; background: #667eea; color: white;
            border: 2px dashed #667eea; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .add-question-btn:hover { background: #5568d3; transform: translateY(-2px); }

        /* Form Fill */
        .form-fill-wrapper { max-width: 800px; margin: 0 auto; }
        .form-header-section {
            background: white; padding: 30px; border-radius: 12px;
            margin-bottom: 20px; text-align: center;
        }
        .form-header-section img { max-width: 100%; border-radius: 12px; margin-bottom: 20px; }
        .form-header-section h1 { color: #2d3748; margin-bottom: 10px; }
        .form-header-section p  { color: #718096; }
        .fill-question-item {
            background: white; padding: 25px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .fill-question-item .question-label {
            font-weight: 600; color: #2d3748; margin-bottom: 15px; font-size: 16px;
        }
        .fill-question-item .required-mark { color: #f56565; margin-left: 5px; }
        .fill-question-item img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .fill-question-item .image-desc {
            color: #718096; font-size: 14px; font-style: italic; margin-bottom: 15px;
        }
        .fill-question-item input[type="text"],
        .fill-question-item textarea {
            width: 100%; padding: 12px; border: 1px solid #cbd5e0;
            border-radius: 6px; font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .fill-question-item textarea { min-height: 100px; resize: vertical; }
        .radio-group, .checkbox-group { display: grid; gap: 10px; }
        .choice-option {
            display: flex; align-items: center; gap: 10px; padding: 12px;
            background: #f7fafc; border: 2px solid #e2e8f0;
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .choice-option:hover { border-color: #667eea; background: #edf2f7; }
        .choice-option input[type="radio"],
        .choice-option input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        /* Success */
        .success-alert {
            background: #48bb78; color: white; padding: 20px; border-radius: 12px;
            text-align: center; margin-bottom: 20px; font-size: 18px;
            font-weight: 600; display: none;
        }
        .success-alert.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: white; padding: 30px; border-radius: 12px;
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { color: #2d3748; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #718096; line-height: 1; }
        .modal-close:hover { color: #2d3748; }
        .share-link-container { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .share-link-container input {
            width: 100%; padding: 10px; border: 1px solid #cbd5e0;
            border-radius: 6px; margin-bottom: 10px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* File Upload */
        .file-upload-label {
            display: inline-block; padding: 10px 20px; background: #667eea;
            color: white; border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .file-upload-label:hover { background: #5568d3; }
        input[type="file"] { display: none; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: #718096; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }

        /* Responses */
        .response-item {
            background: white; padding: 25px; border-radius: 12px;
            margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .response-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e2e8f0;
        }
        .response-content { display: grid; gap: 15px; }
        .response-qa { background: #f7fafc; padding: 15px; border-radius: 8px; }
        .response-qa .q { color: #667eea; font-weight: 600; margin-bottom: 8px; }
        .response-qa .a { color: #2d3748; }

        /* Toast notification */
        .toast {
            position: fixed; bottom: 30px; right: 30px; z-index: 99999;
            background: #2d3748; color: white; padding: 16px 24px;
            border-radius: 10px; font-size: 14px; font-weight: 600;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            transform: translateY(80px); opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 360px;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #48bb78; }
        .toast.error   { background: #f56565; }
        .toast.info    { background: #4299e1; }

        /* Upload progress */
        .upload-progress {
            background: #f7fafc; border: 1px solid #e2e8f0;
            border-radius: 8px; padding: 12px; margin-top: 10px; display: none;
        }
        .upload-progress.active { display: block; }
        .progress-bar-wrap { background: #e2e8f0; border-radius: 4px; height: 8px; overflow: hidden; margin-top: 6px; }
        .progress-bar-fill { height: 100%; background: #667eea; border-radius: 4px; transition: width 0.3s ease; }

        /* Connection status */
        .conn-status {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 12px; padding: 4px 10px; border-radius: 20px;
            font-weight: 600;
        }
        .conn-status.connected    { background: #f0fff4; color: #48bb78; }
        .conn-status.disconnected { background: #fff5f5; color: #f56565; }
        .conn-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header { flex-direction: column; text-align: center; }
            .header-buttons { width: 100%; justify-content: center; }
            .form-item-actions { flex-direction: column; }
            .form-item-actions .btn { width: 100%; }
            .question-header { flex-direction: column; }
            .question-header select { width: 100%; }
        }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<div class="container">

    <!-- ==================== LOGIN PAGE ==================== -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-card">
                <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
                <h2>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶≤‡¶ó‡¶á‡¶®</h2>
                <p>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡¶ø‡¶®</p>
                <div id="dbStatus" style="margin-bottom: 16px;"></div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" onkeypress="if(event.key==='Enter') attemptLogin()">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="attemptLogin()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <p id="defaultPasswordHint" style="margin-top: 20px; font-size: 12px; color: #718096;">
                    ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶®? ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°: <strong>admin123</strong><br>
                    <span style="color: #f56565;">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!</span>
                </p>
            </div>
        </div>
    </div>

    <!-- ==================== ADMIN DASHBOARD ==================== -->
    <div id="adminPage" class="page">
        <div class="app-header">
            <div>
                <h1>üìù ‡¶´‡¶∞‡ßç‡¶Æ ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡¶æ‡¶∞ - ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h1>
                <div style="margin-top: 6px;" id="headerConnStatus"></div>
            </div>
            <div class="header-buttons">
                <button class="btn btn-success"   onclick="createNewForm()">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-warning"   onclick="openChangePasswordModal()">üîê ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</button>
                <button class="btn btn-danger"    onclick="logoutAdmin()">üö™ ‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</button>
            </div>
        </div>

        <div class="card">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>‡¶Æ‡ßã‡¶ü ‡¶´‡¶∞‡ßç‡¶Æ</h3>
                    <div class="number" id="statTotalForms">‚Äî</div>
                </div>
                <div class="stat-card">
                    <h3>‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏</h3>
                    <div class="number" id="statTotalResponses">‚Äî</div>
                </div>
                <div class="stat-card">
                    <h3>‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏</h3>
                    <div class="number" id="statTodayResponses">‚Äî</div>
                </div>
            </div>

            <h2 style="color: #2d3748; margin-bottom: 20px;">‡¶∏‡¶ï‡¶≤ ‡¶´‡¶∞‡ßç‡¶Æ</h2>
            <div id="formsListContainer"></div>
        </div>
    </div>

    <!-- ==================== FORM BUILDER PAGE ==================== -->
    <div id="builderPage" class="page">
        <div class="app-header">
            <h1>üìù ‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø/‡¶∏‡¶Æ‡ßç‡¶™‡¶æ‡¶¶‡¶®‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h1>
            <div class="header-buttons">
                <button class="btn btn-success"   onclick="saveCurrentForm()">üíæ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <button class="btn btn-secondary" onclick="backToAdmin()">‚ùå ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            </div>
        </div>

        <div class="card">
            <div class="form-group">
                <label>‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ <span style="color:#f56565;">*</span></label>
                <input type="text" id="builderFormTitle" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
            </div>
            <div class="form-group">
                <label>‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                <textarea id="builderFormDesc" rows="3" placeholder="‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"></textarea>
            </div>
            <div class="form-group">
                <label>‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
                <label for="builderHeaderImage" class="file-upload-label">üì∑ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <input type="file" id="builderHeaderImage" accept="image/*" onchange="handleHeaderImageUpload(event)">
                <div class="upload-progress" id="headerUploadProgress">
                    <div style="font-size: 13px; color: #718096;" id="headerUploadText">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
                    <div class="progress-bar-wrap">
                        <div class="progress-bar-fill" id="headerProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="headerImagePreview"></div>
            </div>
        </div>

        <div class="card">
            <h3 style="color: #2d3748; margin-bottom: 20px;">‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶∏‡¶Æ‡ßÇ‡¶π</h3>
            <div id="questionsList"></div>
            <button class="add-question-btn" onclick="addNewQuestion()">
                <span style="font-size: 24px;">‚ûï</span>
                <span>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</span>
            </button>
        </div>
    </div>

    <!-- ==================== FORM FILL PAGE (PUBLIC) ==================== -->
    <div id="fillPage" class="page">
        <div class="form-fill-wrapper">
            <div class="success-alert" id="submitSuccess">
                ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§
            </div>
            <div id="fillFormContainer"></div>
        </div>
    </div>

    <!-- ==================== RESPONSES PAGE ==================== -->
    <div id="responsesPage" class="page">
        <div class="app-header">
            <h1 id="responsesPageTitle">‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h1>
            <div class="header-buttons">
                <button class="btn btn-primary"   onclick="exportCurrentResponses()">üì• CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°</button>
                <button class="btn btn-secondary" onclick="backToAdmin()">üîô ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
            </div>
        </div>
        <div class="card">
            <div id="responsesListContainer"></div>
        </div>
    </div>

</div><!-- /container -->

<!-- ==================== SHARE MODAL ==================== -->
<div id="shareModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>üì§ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <button class="modal-close" onclick="closeShareModal()">&times;</button>
        </div>
        <p style="color:#718096; margin-bottom:15px;">‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßá WhatsApp, Messenger, ‡¶¨‡¶æ ‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶ú‡¶æ‡¶Ø‡¶º‡¶ó‡¶æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®:</p>
        <div class="share-link-container">
            <label style="font-weight:600; color:#2d3748; margin-bottom:8px; display:block;">‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡¶ø‡¶Ç‡¶ï:</label>
            <input type="text" id="shareLinkInput" readonly style="font-size:13px;">
            <button class="btn btn-primary" style="width:100%;" onclick="copyShareLink()">üìã ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
        <p id="copySuccessMsg" style="color:#48bb78; margin-top:10px; display:none; text-align:center; font-weight:600;">
            ‚úÖ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ñ‡¶® WhatsApp ‡¶¨‡¶æ Messenger ‡¶è ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        </p>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;">
            <p style="color:#718096; font-size:14px; margin-bottom:10px;">üí° <strong>‡¶ï‡¶ø‡¶≠‡¶æ‡¶¨‡ßá ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®:</strong></p>
            <ol style="color:#718096; font-size:14px; padding-left:20px;">
                <li>‡¶â‡¶™‡¶∞‡ßá‡¶∞ "‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®" ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                <li>WhatsApp, Messenger ‡¶¨‡¶æ Facebook ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</li>
                <li>‡¶Ø‡¶æ‡¶ï‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶§‡ßá ‡¶ö‡¶æ‡¶® ‡¶§‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                <li>‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ñ‡ßÅ‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá</li>
            </ol>
        </div>
    </div>
</div>

<!-- ==================== CHANGE PASSWORD MODAL ==================== -->
<div id="changePasswordModal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>üîê ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
            <button class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
        </div>
        <div class="form-group">
            <label>‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° <span style="color:#f56565;">*</span></label>
            <input type="password" id="currentPassword" placeholder="‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>
        <div class="form-group">
            <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° <span style="color:#f56565;">*</span></label>
            <input type="password" id="newPassword" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞)">
        </div>
        <div class="form-group">
            <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® <span style="color:#f56565;">*</span></label>
            <input type="password" id="confirmPassword" placeholder="‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        </div>
        <div id="passwordChangeError"   style="color:#f56565; margin-bottom:15px; display:none; padding:10px; background:#fff5f5; border-radius:6px;"></div>
        <div id="passwordChangeSuccess" style="color:#48bb78; margin-bottom:15px; display:none; padding:10px; background:#f0fff4; border-radius:6px;"></div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-success"   style="flex:1;" onclick="changeAdminPassword()">‚úÖ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            <button class="btn btn-secondary" onclick="closeChangePasswordModal()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
        </div>
        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #e2e8f0;">
            <p style="color:#718096; font-size:14px; margin-bottom:10px;">üí° <strong>‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ü‡¶ø‡¶™‡¶∏:</strong></p>
            <ul style="color:#718096; font-size:13px; padding-left:20px;">
                <li>‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                <li>‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ö‡¶ø‡¶π‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</li>
                <li>‡¶∏‡¶π‡¶ú ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° (‡¶Ø‡ßá‡¶Æ‡¶®: 123456) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ</li>
                <li>‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶®‡¶ø‡¶Ø‡¶º‡¶Æ‡¶ø‡¶§ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</li>
            </ul>
        </div>
    </div>
</div>

<!-- Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ============================================================
//  SUPABASE CONFIGURATION
// ============================================================
const SUPABASE_URL    = 'https://ibnbhyljvlnzlqntswec.supabase.co';
const SUPABASE_ANON   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlibmJoeWxqdmxuemxxbnRzd2VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NzE0ODcsImV4cCI6MjA4NzE0NzQ4N30.KVHgaAk6mRK67azM1fLWv6YUf9i3AfaJ7R2aSODzOTo';
const STORAGE_BUCKET  = 'form-images';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ============================================================
//  GLOBAL STATE
// ============================================================
let currentEditingFormId = null;
let currentViewingFormId = null;
let questionIdCounter    = 0;
let isConnected          = false;

// ============================================================
//  UTILITY ‚Äî UI
// ============================================================
function showLoading(msg = '‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...') {
    document.getElementById('loadingText').textContent = msg;
    document.getElementById('loadingOverlay').classList.add('active');
}
function hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('active');
}
function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

let toastTimer;
function showToast(msg, type = 'info', duration = 3500) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast ${type} show`;
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => { t.classList.remove('show'); }, duration);
}

function escHtml(s) {
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function escAttr(s) {
    return String(s||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function genFileName(file) {
    const ext = file.name.split('.').pop();
    return `${Date.now()}_${Math.random().toString(36).substr(2,8)}.${ext}`;
}

// ============================================================
//  CONNECTION CHECK & INIT
// ============================================================
async function checkConnection() {
    try {
        const { error } = await supabase.from('admin_settings').select('id').limit(1);
        isConnected = !error;
    } catch(e) { isConnected = false; }
    updateConnUI();
    return isConnected;
}

function updateConnUI() {
    const html = isConnected
        ? `<span class="conn-status connected"><span class="conn-dot"></span>Supabase ‡¶∏‡¶Ç‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‚úì</span>`
        : `<span class="conn-status disconnected"><span class="conn-dot"></span>‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶® ‚úó</span>`;
    document.querySelectorAll('#dbStatus, #headerConnStatus').forEach(el => { if(el) el.innerHTML = html; });
}

document.addEventListener('DOMContentLoaded', async () => {
    showLoading('Supabase ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

    await checkConnection();

    const urlParams = new URLSearchParams(window.location.search);
    const formId    = urlParams.get('form');

    if (formId) {
        await checkForPublicForm(formId);
    } else {
        await updatePasswordHint();
        checkIfLoggedIn();
    }

    hideLoading();
});

function checkIfLoggedIn() {
    if (sessionStorage.getItem('adminLoggedIn') === 'true') showAdminDashboard();
}

async function updatePasswordHint() {
    try {
        const { data } = await supabase.from('admin_settings').select('password').eq('id', 1).single();
        if (data && data.password !== 'admin123') {
            const hint = document.getElementById('defaultPasswordHint');
            if (hint) hint.style.display = 'none';
        }
    } catch(e) {}
}

// ============================================================
//  AUTHENTICATION
// ============================================================
async function attemptLogin() {
    const password = document.getElementById('loginPassword').value.trim();
    if (!password) { showToast('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®!', 'error'); return; }

    showLoading('‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    try {
        const { data, error } = await supabase.from('admin_settings').select('password').eq('id', 1).single();
        hideLoading();

        if (error) { showToast('‚ùå ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶ú ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!', 'error'); return; }

        const adminPw = data?.password || 'admin123';
        if (password === adminPw) {
            sessionStorage.setItem('adminLoggedIn', 'true');
            showAdminDashboard();
            showToast('‚úÖ ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡¶´‡¶≤! ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ‡•§', 'success');
        } else {
            showToast('‚ùå ‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶°! ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
            document.getElementById('loginPassword').value = '';
        }
    } catch(e) {
        hideLoading();
        showToast('‚ùå ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ! ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'error');
    }
}

function logoutAdmin() {
    if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
    sessionStorage.removeItem('adminLoggedIn');
    showPage('loginPage');
    document.getElementById('loginPassword').value = '';
    showToast('‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü ‡¶∏‡¶´‡¶≤‡•§', 'info');
}

// ============================================================
//  PASSWORD CHANGE
// ============================================================
function openChangePasswordModal() {
    ['currentPassword','newPassword','confirmPassword'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('passwordChangeError').style.display   = 'none';
    document.getElementById('passwordChangeSuccess').style.display = 'none';
    document.getElementById('changePasswordModal').classList.add('active');
}
function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
}

async function changeAdminPassword() {
    const cur  = document.getElementById('currentPassword').value;
    const nw   = document.getElementById('newPassword').value;
    const conf = document.getElementById('confirmPassword').value;
    const errD = document.getElementById('passwordChangeError');
    const sucD = document.getElementById('passwordChangeSuccess');
    errD.style.display = sucD.style.display = 'none';

    if (!cur || !nw || !conf) {
        errD.textContent = '‚ùå ‡¶∏‡¶ï‡¶≤ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!'; errD.style.display = 'block'; return;
    }

    showLoading('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const { data } = await supabase.from('admin_settings').select('password').eq('id',1).single();
    hideLoading();

    if (cur !== (data?.password || 'admin123')) {
        errD.textContent = '‚ùå ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≠‡ßÅ‡¶≤!'; errD.style.display = 'block'; return;
    }
    if (nw.length < 6) {
        errD.textContent = '‚ùå ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß¨ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!'; errD.style.display = 'block'; return;
    }
    if (nw !== conf) {
        errD.textContent = '‚ùå ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶®‡¶æ!'; errD.style.display = 'block'; return;
    }
    if (nw === cur) {
        errD.textContent = '‚ùå ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶ó‡ßá‡¶∞‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ!'; errD.style.display = 'block'; return;
    }

    showLoading('‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const { error } = await supabase.from('admin_settings')
        .update({ password: nw, updated_at: new Date().toISOString() }).eq('id', 1);
    hideLoading();

    if (error) {
        errD.textContent = '‚ùå ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§'; errD.style.display = 'block';
    } else {
        sucD.textContent = '‚úÖ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!'; sucD.style.display = 'block';
        ['currentPassword','newPassword','confirmPassword'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('defaultPasswordHint').style.display = 'none';
        setTimeout(() => closeChangePasswordModal(), 2000);
        showToast('‚úÖ ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶∏‡¶´‡¶≤!', 'success');
    }
}

// ============================================================
//  PUBLIC FORM
// ============================================================
async function checkForPublicForm(formId) {
    showLoading('‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    document.querySelectorAll('.app-header').forEach(h => h.style.display = 'none');

    const { data: form, error } = await supabase.from('forms').select('*').eq('id', formId).single();
    hideLoading();

    if (error || !form) {
        showPage('fillPage');
        document.getElementById('fillFormContainer').innerHTML = `
            <div style="text-align:center; padding:60px 20px;">
                <div style="font-size:64px; margin-bottom:20px;">‚ùå</div>
                <h2 style="color:#2d3748; margin-bottom:10px;">‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</h2>
                <p style="color:#718096;">‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶¨‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ü‡¶ø ‡¶≠‡ßÅ‡¶≤‡•§</p>
            </div>`;
    } else {
        renderPublicFormFill(formId, form);
    }
}

// ============================================================
//  ADMIN DASHBOARD
// ============================================================
async function showAdminDashboard() {
    showPage('adminPage');
    updateConnUI();
    await Promise.all([loadAdminStats(), loadFormsList()]);
}

function backToAdmin() {
    currentEditingFormId = null;
    showAdminDashboard();
}

async function loadAdminStats() {
    try {
        const [{ count: fc }, { count: rc }] = await Promise.all([
            supabase.from('forms').select('*', { count: 'exact', head: true }),
            supabase.from('responses').select('*', { count: 'exact', head: true })
        ]);

        const today = new Date().toISOString().split('T')[0];
        const { count: tc } = await supabase.from('responses')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', today + 'T00:00:00')
            .lte('created_at', today + 'T23:59:59');

        document.getElementById('statTotalForms').textContent    = fc || 0;
        document.getElementById('statTotalResponses').textContent = rc || 0;
        document.getElementById('statTodayResponses').textContent = tc || 0;
    } catch(e) {
        document.getElementById('statTotalForms').textContent = '‚Äî';
    }
}

async function loadFormsList() {
    const container = document.getElementById('formsListContainer');
    container.innerHTML = `<div style="text-align:center;padding:30px;color:#718096;">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>`;

    const { data: forms, error } = await supabase.from('forms')
        .select('id, title, description, created_at')
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = `<p style="color:#f56565;">‚ö†Ô∏è ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${error.message}</p>`;
        return;
    }

    if (!forms || forms.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìù</div>
                <h3>‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø</h3>
                <p>‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶∞‡ßç‡¶Æ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶â‡¶™‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
            </div>`;
        return;
    }

    // get response counts
    const { data: respCounts } = await supabase
        .from('responses').select('form_id');

    const countMap = {};
    (respCounts || []).forEach(r => { countMap[r.form_id] = (countMap[r.form_id] || 0) + 1; });

    container.innerHTML = '<div class="forms-grid"></div>';
    const grid = container.querySelector('.forms-grid');

    forms.forEach(form => {
        const count   = countMap[form.id] || 0;
        const created = form.created_at ? new Date(form.created_at).toLocaleDateString('bn-BD') : 'N/A';
        const item    = document.createElement('div');
        item.className = 'form-item';
        item.innerHTML = `
            <div class="form-item-header">
                <h3>${escHtml(form.title)}</h3>
                <p>${escHtml(form.description || '‡¶ï‡ßã‡¶® ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶®‡ßá‡¶á')}</p>
            </div>
            <div class="form-item-meta">
                üìä ${count} ‡¶ü‡¶ø ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ &nbsp;|&nbsp; üìÖ ‡¶§‡ßà‡¶∞‡¶ø: ${created}
            </div>
            <div class="form-item-actions">
                <button class="btn btn-warning  btn-sm" onclick="openShareModal('${form.id}')">üì§ ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞</button>
                <button class="btn btn-info     btn-sm" onclick="previewForm('${form.id}')">üëÅÔ∏è ‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</button>
                <button class="btn btn-primary  btn-sm" onclick="viewFormResponses('${form.id}')">üìä ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ (${count})</button>
                <button class="btn btn-secondary btn-sm" onclick="editForm('${form.id}')">‚úèÔ∏è ‡¶è‡¶°‡¶ø‡¶ü</button>
                <button class="btn btn-secondary btn-sm" onclick="duplicateForm('${form.id}')">üìã ‡¶ï‡¶™‡¶ø</button>
                <button class="btn btn-danger   btn-sm" onclick="deleteForm('${form.id}')">üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>`;
        grid.appendChild(item);
    });
}

// ============================================================
//  SHARE MODAL
// ============================================================
function openShareModal(formId) {
    const base = window.location.href.split('?')[0];
    document.getElementById('shareLinkInput').value = base + '?form=' + formId;
    document.getElementById('shareModal').classList.add('active');
    document.getElementById('copySuccessMsg').style.display = 'none';
}
function closeShareModal() { document.getElementById('shareModal').classList.remove('active'); }
function copyShareLink() {
    const input = document.getElementById('shareLinkInput');
    input.select(); input.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(input.value).catch(() => document.execCommand('copy'));
    document.getElementById('copySuccessMsg').style.display = 'block';
    setTimeout(() => document.getElementById('copySuccessMsg').style.display = 'none', 3000);
    showToast('‚úÖ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
}

// ============================================================
//  FORM BUILDER ‚Äî CRUD
// ============================================================
function createNewForm() {
    currentEditingFormId = null;
    questionIdCounter    = 0;
    document.getElementById('builderFormTitle').value = '';
    document.getElementById('builderFormDesc').value  = '';
    document.getElementById('builderHeaderImage').value = '';
    document.getElementById('headerImagePreview').innerHTML = '';
    document.getElementById('headerUploadProgress').classList.remove('active');
    document.getElementById('questionsList').innerHTML = '';
    addNewQuestion();
    showPage('builderPage');
}

async function editForm(formId) {
    showLoading('‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const { data: form, error } = await supabase.from('forms').select('*').eq('id', formId).single();
    hideLoading();
    if (error || !form) { showToast('‚ùå ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'error'); return; }

    currentEditingFormId = formId;
    questionIdCounter    = 0;

    document.getElementById('builderFormTitle').value = form.title || '';
    document.getElementById('builderFormDesc').value  = form.description || '';
    document.getElementById('headerUploadProgress').classList.remove('active');

    if (form.header_image) {
        document.getElementById('headerImagePreview').innerHTML = `
            <div class="image-preview-box">
                <img src="${escHtml(form.header_image)}" alt="header">
                <button class="btn btn-danger btn-sm" onclick="removeHeaderImage()">‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>`;
    } else {
        document.getElementById('headerImagePreview').innerHTML = '';
    }

    document.getElementById('questionsList').innerHTML = '';
    const questions = form.questions || [];
    if (questions.length > 0) questions.forEach(q => addNewQuestion(q));
    else addNewQuestion();

    showPage('builderPage');
}

async function duplicateForm(formId) {
    if (!confirm('‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶ï‡¶™‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
    showLoading('‡¶ï‡¶™‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

    const { data: form, error: fe } = await supabase.from('forms').select('*').eq('id', formId).single();
    if (fe || !form) { hideLoading(); showToast('‚ùå ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•!', 'error'); return; }

    const { error } = await supabase.from('forms').insert({
        title: form.title + ' (‡¶ï‡¶™‡¶ø)',
        description: form.description,
        header_image: form.header_image,
        questions: form.questions
    });

    hideLoading();
    if (error) { showToast('‚ùå ‡¶ï‡¶™‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + error.message, 'error'); }
    else { showToast('‚úÖ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success'); await loadFormsList(); }
}

async function deleteForm(formId) {
    if (!confirm('‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶´‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶¨ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏‡¶ì ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§')) return;
    showLoading('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

    // delete responses first (cascade should handle it, but explicit is safer)
    await supabase.from('responses').delete().eq('form_id', formId);
    const { error } = await supabase.from('forms').delete().eq('id', formId);

    hideLoading();
    if (error) { showToast('‚ùå ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message, 'error'); }
    else { showToast('‚úÖ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success'); await showAdminDashboard(); }
}

function previewForm(formId) {
    window.open(window.location.href.split('?')[0] + '?form=' + formId, '_blank');
}

// ============================================================
//  IMAGE UPLOAD ‚Üí SUPABASE STORAGE
// ============================================================
async function uploadImageToStorage(file, folder = 'misc') {
    const fileName = folder + '/' + genFileName(file);
    const { data, error } = await supabase.storage
        .from(STORAGE_BUCKET)
        .upload(fileName, file, { cacheControl: '3600', upsert: false });

    if (error) throw new Error(error.message);

    const { data: urlData } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(data.path);
    return urlData.publicUrl;
}

async function handleHeaderImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { showToast('‚ùå ‡¶õ‡¶¨‡¶ø ‡ß´MB ‡¶è‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶õ‡ßã‡¶ü ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!', 'error'); return; }

    const prog = document.getElementById('headerUploadProgress');
    const bar  = document.getElementById('headerProgressBar');
    const txt  = document.getElementById('headerUploadText');
    prog.classList.add('active');
    bar.style.width = '20%';
    txt.textContent = '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

    try {
        bar.style.width = '60%';
        const imageUrl = await uploadImageToStorage(file, 'headers');
        bar.style.width = '100%';
        txt.textContent = '‚úÖ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!';

        setTimeout(() => prog.classList.remove('active'), 1500);

        document.getElementById('headerImagePreview').innerHTML = `
            <div class="image-preview-box">
                <img src="${escHtml(imageUrl)}" alt="header preview">
                <button class="btn btn-danger btn-sm" onclick="removeHeaderImage()">‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>`;
        showToast('‚úÖ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
    } catch(e) {
        prog.classList.remove('active');
        showToast('‚ùå ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + e.message, 'error');
    }
}

function removeHeaderImage() {
    document.getElementById('builderHeaderImage').value = '';
    document.getElementById('headerImagePreview').innerHTML = '';
}

async function handleQuestionImageUpload(event, qId) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { showToast('‚ùå ‡¶õ‡¶¨‡¶ø ‡ß´MB ‡¶è‡¶∞ ‡¶ö‡ßá‡¶Ø‡¶º‡ßá ‡¶õ‡ßã‡¶ü ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá!', 'error'); return; }

    const progId = qId + '_progress';
    document.getElementById(progId).classList.add('active');
    document.getElementById(progId + '_bar').style.width  = '40%';
    document.getElementById(progId + '_txt').textContent  = '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...';

    try {
        const imageUrl = await uploadImageToStorage(file, 'questions');
        document.getElementById(progId + '_bar').style.width = '100%';
        document.getElementById(progId + '_txt').textContent = '‚úÖ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!';
        setTimeout(() => document.getElementById(progId).classList.remove('active'), 1500);

        document.getElementById(qId + '_imgPreview').innerHTML = `
            <div class="image-preview-box">
                <img src="${escHtml(imageUrl)}" alt="question image">
                <input type="text" class="q-img-desc"
                    placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"
                    style="width:100%; padding:10px; margin:10px 0; border:1px solid #cbd5e0; border-radius:6px; font-family:inherit;">
                <button class="btn btn-danger btn-sm" onclick="removeQuestionImage('${qId}')">‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>`;
        showToast('‚úÖ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
    } catch(e) {
        document.getElementById(progId).classList.remove('active');
        showToast('‚ùå ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + e.message, 'error');
    }
}

function removeQuestionImage(qId) {
    document.getElementById(qId + '_img').value = '';
    document.getElementById(qId + '_imgPreview').innerHTML = '';
}

// ============================================================
//  QUESTION BUILDER
// ============================================================
function addNewQuestion(questionData = null) {
    questionIdCounter++;
    const qId   = 'question_' + questionIdCounter;
    const list  = document.getElementById('questionsList');
    const div   = document.createElement('div');
    div.className = 'question-item';
    div.id = qId;

    const type      = questionData?.type            || 'short';
    const text      = questionData?.text            || '';
    const required  = questionData?.required        || false;
    const image     = questionData?.image           || null;
    const imageDesc = questionData?.imageDescription || '';
    const options   = questionData?.options         || [];

    const progId = qId + '_progress';

    div.innerHTML = `
        <div class="question-header">
            <input type="text" class="q-text" placeholder="‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" value="${escAttr(text)}">
            <select class="q-type" onchange="updateQuestionType('${qId}')">
                <option value="short"    ${type==='short'    ?'selected':''}>‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶â‡¶§‡ßç‡¶§‡¶∞</option>
                <option value="long"     ${type==='long'     ?'selected':''}>‡¶¶‡ßÄ‡¶∞‡ßç‡¶ò ‡¶â‡¶§‡ßç‡¶§‡¶∞</option>
                <option value="radio"    ${type==='radio'    ?'selected':''}>‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                <option value="checkbox" ${type==='checkbox' ?'selected':''}>‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶®</option>
                <option value="dropdown" ${type==='dropdown' ?'selected':''}>‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶®</option>
            </select>
        </div>

        <div class="question-image-section">
            <label for="${qId}_img" class="file-upload-label">üì∑ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)</label>
            <input type="file" id="${qId}_img" accept="image/*" onchange="handleQuestionImageUpload(event, '${qId}')">
            <div class="upload-progress" id="${progId}">
                <div style="font-size:13px; color:#718096;" id="${progId}_txt">‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
                <div class="progress-bar-wrap">
                    <div class="progress-bar-fill" id="${progId}_bar" style="width:0%"></div>
                </div>
            </div>
            <div id="${qId}_imgPreview">
                ${image ? `
                <div class="image-preview-box">
                    <img src="${escHtml(image)}" alt="question image">
                    <input type="text" class="q-img-desc"
                        placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)"
                        value="${escAttr(imageDesc)}"
                        style="width:100%; padding:10px; margin:10px 0; border:1px solid #cbd5e0; border-radius:6px; font-family:inherit;">
                    <button class="btn btn-danger btn-sm" onclick="removeQuestionImage('${qId}')">‡¶õ‡¶¨‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                </div>` : ''}
            </div>
        </div>

        <div class="options-list" id="${qId}_options"></div>

        <div class="question-footer">
            <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                <input type="checkbox" class="q-required" ${required?'checked':''}>
                <span>‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</span>
            </label>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-secondary btn-sm" onclick="duplicateQuestion('${qId}')">üìã ‡¶ï‡¶™‡¶ø</button>
                <button class="btn btn-danger    btn-sm" onclick="deleteQuestion('${qId}')">üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
            </div>
        </div>`;

    list.appendChild(div);
    if (['radio','checkbox','dropdown'].includes(type)) showOptionsForQuestion(qId, options);
}

function updateQuestionType(qId) {
    const div  = document.getElementById(qId);
    const type = div.querySelector('.q-type').value;
    const opts = div.querySelector('.options-list');
    if (['radio','checkbox','dropdown'].includes(type)) showOptionsForQuestion(qId);
    else opts.innerHTML = '';
}

function showOptionsForQuestion(qId, existingOptions = []) {
    const c = document.getElementById(qId + '_options');
    c.innerHTML = `
        <div id="${qId}_optionsList"></div>
        <button class="btn btn-secondary btn-sm" onclick="addOptionToQuestion('${qId}')">‚ûï ‡¶Ö‡¶™‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>`;
    if (existingOptions.length > 0) existingOptions.forEach(o => addOptionToQuestion(qId, o));
    else addOptionToQuestion(qId);
}

function addOptionToQuestion(qId, optionText = '') {
    const list   = document.getElementById(qId + '_optionsList');
    const optId  = qId + '_opt_' + Date.now();
    const optDiv = document.createElement('div');
    optDiv.className = 'option-row';
    optDiv.id = optId;
    optDiv.innerHTML = `
        <span>‚ö™</span>
        <input type="text" class="opt-text" placeholder="‡¶Ö‡¶™‡¶∂‡¶® ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü" value="${escAttr(optionText)}">
        <button class="btn btn-danger btn-sm" onclick="document.getElementById('${optId}').remove()">‚úï</button>`;
    list.appendChild(optDiv);
}

function duplicateQuestion(qId) {
    const data = extractQuestionData(document.getElementById(qId));
    addNewQuestion(data);
}

function deleteQuestion(qId) {
    const list = document.getElementById('questionsList');
    if (list.children.length <= 1) { showToast('‚ö†Ô∏è ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá!', 'error'); return; }
    document.getElementById(qId).remove();
}

function extractQuestionData(div) {
    const type     = div.querySelector('.q-type').value;
    const text     = div.querySelector('.q-text').value;
    const required = div.querySelector('.q-required').checked;
    const imgEl    = div.querySelector('.image-preview-box img');
    const image    = imgEl ? imgEl.src : null;
    const descEl   = div.querySelector('.q-img-desc');
    const imageDescription = descEl ? descEl.value : '';
    const options  = [];
    if (['radio','checkbox','dropdown'].includes(type)) {
        div.querySelectorAll('.opt-text').forEach(o => { if(o.value.trim()) options.push(o.value.trim()); });
    }
    return { type, text, required, image, imageDescription, options };
}

// ============================================================
//  SAVE FORM ‚Üí SUPABASE
// ============================================================
async function saveCurrentForm() {
    const title = document.getElementById('builderFormTitle').value.trim();
    if (!title) { showToast('‚ùå ‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶∂‡¶ø‡¶∞‡ßã‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!', 'error'); return; }

    const description  = document.getElementById('builderFormDesc').value.trim();
    const headerImgEl  = document.querySelector('#headerImagePreview img');
    const header_image = headerImgEl ? headerImgEl.src : null;

    const questions = [];
    document.querySelectorAll('.question-item').forEach(div => {
        const q = extractQuestionData(div);
        if (q.text.trim()) questions.push(q);
    });

    if (questions.length === 0) { showToast('‚ùå ‡¶Ö‡¶®‡ßç‡¶§‡¶§ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®!', 'error'); return; }

    showLoading('Supabase ‡¶è ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

    const payload = { title, description, header_image, questions, updated_at: new Date().toISOString() };
    let error;

    if (currentEditingFormId) {
        ({ error } = await supabase.from('forms').update(payload).eq('id', currentEditingFormId));
    } else {
        ({ error } = await supabase.from('forms').insert(payload));
    }

    hideLoading();

    if (error) {
        showToast('‚ùå ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•: ' + error.message, 'error');
    } else {
        showToast('‚úÖ ‡¶´‡¶∞‡ßç‡¶Æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
        backToAdmin();
    }
}

// ============================================================
//  PUBLIC FORM FILL ‚Äî RENDER
// ============================================================
function renderPublicFormFill(formId, form) {
    currentViewingFormId = formId;
    const container = document.getElementById('fillFormContainer');
    const questions = form.questions || [];

    let html = `<div class="form-header-section">`;
    if (form.header_image) html += `<img src="${escHtml(form.header_image)}" alt="form header">`;
    html += `<h1>${escHtml(form.title)}</h1>`;
    if (form.description) html += `<p>${escHtml(form.description)}</p>`;
    html += `</div>`;

    questions.forEach((q, idx) => {
        html += `<div class="fill-question-item">`;
        html += `<div class="question-label">${escHtml(q.text)}`;
        if (q.required) html += `<span class="required-mark">*</span>`;
        html += `</div>`;

        if (q.image) {
            html += `<img src="${escHtml(q.image)}" alt="question image">`;
            if (q.imageDescription) html += `<div class="image-desc">${escHtml(q.imageDescription)}</div>`;
        }

        if (q.type === 'short') {
            html += `<input type="text" class="answer-input" data-idx="${idx}" ${q.required?'required':''} placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">`;
        } else if (q.type === 'long') {
            html += `<textarea class="answer-input" data-idx="${idx}" ${q.required?'required':''} placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®"></textarea>`;
        } else if (q.type === 'radio') {
            html += `<div class="radio-group">`;
            (q.options||[]).forEach(opt => {
                html += `<label class="choice-option">
                    <input type="radio" name="q${idx}" value="${escAttr(opt)}" class="answer-input" data-idx="${idx}" ${q.required?'required':''}>
                    <span>${escHtml(opt)}</span></label>`;
            });
            html += `</div>`;
        } else if (q.type === 'checkbox') {
            html += `<div class="checkbox-group">`;
            (q.options||[]).forEach(opt => {
                html += `<label class="choice-option">
                    <input type="checkbox" value="${escAttr(opt)}" class="answer-checkbox" data-idx="${idx}">
                    <span>${escHtml(opt)}</span></label>`;
            });
            html += `</div>`;
        } else if (q.type === 'dropdown') {
            html += `<select class="answer-input" data-idx="${idx}" ${q.required?'required':''} style="width:100%; padding:12px; border:1px solid #cbd5e0; border-radius:6px; font-family:inherit;">
                <option value="">‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>`;
            (q.options||[]).forEach(opt => { html += `<option value="${escAttr(opt)}">${escHtml(opt)}</option>`; });
            html += `</select>`;
        }

        html += `</div>`;
    });

    html += `<div style="margin-top:20px; text-align:center;">
        <button class="btn btn-success" style="padding:15px 40px; font-size:16px;" onclick="submitFormResponse()">‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
    </div>`;

    container.innerHTML = html;
    document.getElementById('submitSuccess').classList.remove('show');
    showPage('fillPage');
}

// ============================================================
//  SUBMIT RESPONSE ‚Üí SUPABASE
// ============================================================
async function submitFormResponse() {
    const { data: form, error: fe } = await supabase.from('forms').select('*').eq('id', currentViewingFormId).single();
    if (fe || !form) { showToast('‚ùå ‡¶´‡¶∞‡ßç‡¶Æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!', 'error'); return; }

    const questions = form.questions || [];
    const answers   = [];

    for (let i = 0; i < questions.length; i++) {
        const q = questions[i];

        if (q.type === 'checkbox') {
            const checked = Array.from(document.querySelectorAll(`.answer-checkbox[data-idx="${i}"]:checked`)).map(c => c.value);
            if (q.required && checked.length === 0) { showToast(`"${q.text}" ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï!`, 'error'); return; }
            answers.push(checked.join(', '));
        } else {
            let value = '';
            if (q.type === 'radio') {
                const checked = document.querySelector(`input[name="q${i}"]:checked`);
                value = checked ? checked.value : '';
            } else {
                const input = document.querySelector(`.answer-input[data-idx="${i}"]`);
                value = input ? input.value.trim() : '';
            }
            if (q.required && !value) { showToast(`"${q.text}" ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï!`, 'error'); return; }
            answers.push(value);
        }
    }

    showLoading('Supabase ‡¶è ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const { error } = await supabase.from('responses').insert({ form_id: currentViewingFormId, answers });
    hideLoading();

    if (error) { showToast('‚ùå ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ' + error.message, 'error'); return; }

    document.getElementById('submitSuccess').classList.add('show');
    document.getElementById('fillFormContainer').innerHTML = '';

    const isPublic = new URLSearchParams(window.location.search).get('form');
    if (isPublic) {
        setTimeout(() => {
            document.getElementById('fillFormContainer').innerHTML = `
                <div style="text-align:center; padding:60px 20px;">
                    <div style="font-size:64px; margin-bottom:20px;">‚úÖ</div>
                    <h2 style="color:#2d3748; margin-bottom:10px;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶!</h2>
                    <p style="color:#718096;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</p>
                    <button class="btn btn-primary" style="margin-top:20px;" onclick="location.reload()">‡¶Ü‡¶∞‡ßá‡¶ï‡¶ü‡¶ø ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                </div>`;
            document.getElementById('submitSuccess').classList.remove('show');
        }, 2000);
    } else {
        setTimeout(() => backToAdmin(), 2000);
    }
}

// ============================================================
//  VIEW RESPONSES
// ============================================================
async function viewFormResponses(formId) {
    showLoading('‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');

    const [{ data: form }, { data: responses }] = await Promise.all([
        supabase.from('forms').select('*').eq('id', formId).single(),
        supabase.from('responses').select('*').eq('form_id', formId).order('created_at', { ascending: false })
    ]);

    hideLoading();
    if (!form) { showToast('‚ùå ‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!', 'error'); return; }

    currentViewingFormId = formId;
    document.getElementById('responsesPageTitle').textContent = `"${form.title}" ‡¶è‡¶∞ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ (${(responses||[]).length})`;

    const container = document.getElementById('responsesListContainer');
    const questions = form.questions || [];

    if (!responses || responses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3>‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶® ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶Ü‡¶∏‡ßá‡¶®‡¶ø</h3>
            </div>`;
    } else {
        container.innerHTML = '';
        responses.forEach((resp, idx) => {
            const dateStr = resp.created_at ? new Date(resp.created_at).toLocaleString('bn-BD') : 'N/A';
            const div = document.createElement('div');
            div.className = 'response-item';

            let html = `
                <div class="response-header">
                    <strong style="color:#2d3748;">‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ #${idx + 1}</strong>
                    <span style="color:#718096;">${dateStr}</span>
                </div>
                <div class="response-content">`;

            questions.forEach((q, qi) => {
                const ans = Array.isArray(resp.answers) ? resp.answers[qi] : '';
                html += `
                    <div class="response-qa">
                        <div class="q">${escHtml(q.text)}</div>
                        <div class="a">${escHtml(ans || '‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø')}</div>
                    </div>`;
            });

            html += `</div>
                <div style="text-align:right; margin-top:15px;">
                    <button class="btn btn-danger btn-sm" onclick="deleteResponse('${resp.id}', '${formId}')">üóëÔ∏è ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®</button>
                </div>`;

            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    showPage('responsesPage');
}

async function deleteResponse(respId, formId) {
    if (!confirm('‡¶è‡¶á ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) return;
    showLoading('‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const { error } = await supabase.from('responses').delete().eq('id', respId);
    hideLoading();
    if (error) { showToast('‚ùå ‡¶Æ‡ßÅ‡¶õ‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ: ' + error.message, 'error'); }
    else { showToast('‚úÖ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§', 'info'); await viewFormResponses(formId); }
}

// ============================================================
//  CSV EXPORT
// ============================================================
async function exportCurrentResponses() {
    showLoading('CSV ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...');
    const [{ data: form }, { data: responses }] = await Promise.all([
        supabase.from('forms').select('*').eq('id', currentViewingFormId).single(),
        supabase.from('responses').select('*').eq('form_id', currentViewingFormId).order('created_at', { ascending: false })
    ]);
    hideLoading();

    if (!responses || responses.length === 0) { showToast('‚ö†Ô∏è ‡¶ï‡ßã‡¶® ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á!', 'error'); return; }

    const questions = form.questions || [];
    let csv = '\uFEFF';
    csv += '‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏ ‡¶®‡¶Ç,‡¶∏‡¶Æ‡¶Ø‡¶º,' + questions.map(q => `"${q.text}"`).join(',') + '\n';

    responses.forEach((resp, idx) => {
        const dateStr = resp.created_at ? new Date(resp.created_at).toLocaleString('bn-BD') : 'N/A';
        const answers = Array.isArray(resp.answers) ? resp.answers : [];
        csv += `${idx + 1},"${dateStr}",` + answers.map(a => `"${String(a||'').replace(/"/g,'""')}"`).join(',') + '\n';
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href     = URL.createObjectURL(blob);
    link.download = `${form.title}_responses_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    showToast('‚úÖ CSV ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'success');
}
</script>
</body>
</html>
